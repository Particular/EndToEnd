# Permutations
The team building the performance tests did a careful selection on which [permutations](EndToEnd/docs/terminology.md) to test, to limit the number of tests to run. All possible unique scenario would've resulted in thousands of different tests, which was trimmed down to only a few dozen scenarios.

## Permutation generation
Each permutation tested is generated in a single folder that holds an executable and the appropriate test assemblies and NServiceBus related transport and persistence assemblies. A batch file is included to execute the test with the appropriate parameters.

The permutations are generated by NUnit test fixtures that contain the appropriate scenarios, decorated by the `TestCaseSourceAttribute` to generate the different scenarios. The `Permutation` class holds the variables for a specific permutation and the `PermutationGenerator` class is used to provide different permutation to each tests in a scenario.

If we take the `PersistersFixture` as example, we want to test subscription- and Saga storage for each of the persisters. This results in two tests in this fixture:

- GatedPublishRunner
- SagaInitiateRunner

If we take the `GatedPublishRunner` as example we see the following code

```
[TestCaseSource(nameof(CreatePermutations))]
public override void GatedPublishRunner(Permutation permutation)
{
    base.GatedPublishRunner(permutation);
}
```

The `TestCaseSource` runs the `CreatePermutations()` method to execute this test with different variables. Every fixture has its unique set of permutations:

- Only MSMQ transport is used
- Only JSON serialization is applied
- Outbox feature is disabled
- Every single persister of the `Persistence` enumeration is used

The base class contains every single scenario and the tests in a test fixture will call the base class to actually generate all permutations. The base class `Base` then runs the method `void Tasks(Permutation permutation, [CallerMemberName] string memberName = "")`, which in place calls the `TestEnvironment` class.

Finally the `Base` class will execute the permutation and wait for results. If the test doesn't finish in 150 seconds the permutation will be killed and the test will fail. If the process returns any result besides 0, the test will fail as well.

## TestEnvironment generator
The `TestEnvironment` class does basically the following

- Remove any files already in the permutation folder
- Copy all files into the permutation folder
- Create a batch file
- Update the app.config file with gcServer based on permutation

All files will be compiled into the \bin\ folder and then copied to a folder with a name specific to that permutation. It can be found under \bin\@\[permutation_name]. This is where the batch file (.bat) can also be executed from to manually start the performance test.

## Permutation execution

As mentioned the test will run for at most 150 seconds and the test process will be killed if it is not finished by then. When a test requires seeding, the total duration time of a test will be trimmed down to fit inside the 150 seconds. Read more on [permutation execution](EndToEnd/docs/permutation-execution.md).
